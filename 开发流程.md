## 一、开发规范

在**开发或者重构一个大功能**之前，首先应该在 WIKI 上书写 **设计文档** 。

- 如果是现有组件的研发和重构，需要经过相关组件负责人以及 leader 的评审。
- 如果是新组件的研发和重构，需要经过 leader 组织相关熟悉技术同学进行设计文档评审。评审通过之后方可进行开发。

## 二、代码提交规范

### 1. commit 提交规范

#### 1.1 commit message 规范

详细可以参考 [Commit message 和 Change log 编写指南](http://www.ruanyifeng.com/blog/2016/01/commit_message_change_log.html)，我们对于 commit message 的要求有一些略微的差异。重点总结如下

commit message 格式为 **`<type>(<scope>): <subject>`**。

其中 `type` 用于说明 commit 的类别，只允许使用下面9个标识：

- **feat**：新功能（feature）
- **fix**：修补bug
- **docs**：文档（documentation）
- **style**： 格式（不影响代码运行的变动）
- **refactor**：重构（即不是新增功能，也不是修改bug的代码变动）
- **test**：增加测试
- **build | chore**：构建过程或辅助工具的变动
- **ci**：更改 ci 配置和脚本

日常大家会常用的基本是 feat 和 fix 两个。

scope 说明你要更改的组件，例如要更改的是 scheduler，则 <scope> 部分书写 scheduler。

subject 说明本次提交具体实现的功能，做的事情。

下面是一些 commit 的例子：

- feat(portal2): add paging for machinelist page
- fix(rjob): fix bugs for not printing error messages
- build: upgrade bazel to 1.0
- ci: change ci memory config for deploy_platform

#### 1.2 commit 提交规范

提交 commit 前，请一定执行下述操作：

```
git pull origin master --rebase
```

如果自己的分支名为 feat/scope-xxx，提交完之后可以 git push -f 到自己的分支：

```
git push --force-with-lease origin feat/scope-xxx
```

请在脑海中**务必务必务必**记住下列准则：

***所有 pull 操作请记得添加 --rebase***

***所有 pull 操作请记得添加 --rebase***

***所有 pull 操作请记得添加 --rebase***

***所有 pull 操作请记得添加 --rebase***

***所有 pull 操作请记得添加 --rebase***

### 2. branch 命名规范

branch 命名规范可以类似上面的 commit 提交规范：

branch 格式为 **`<type>/<scope>-<title>`**

相关 <type>, <scope> 的意义参照 commit 提交规范，<title> 为本 branch 的功能描述。

下面是一些 branch 的例子：

- feat/dockerauth-init
- feat/unsullied-improve-network
- fix/scheduler-lock-bug
- docs/bazel-improve-docs

### 3. Merge Request 提交规范

每一个 MR 必须有对应的 JIRA 或者 WIKI，说明该功能，关于什么时候写 JIRA，什么时候写 WIKI，说明如下：

- 如果是新 Feature 或者新组件的开发，一定要写明设计文档，可以将设计文档书写在 WIKI 中，然后在 MR 中附上设计文档的 WIKI 链接。
- 如果是修复 bug，或者是一些简单的功能开发，需要开一个 JIRA，并在 MR 或者 commit 中填入 JIRA 的 id。（参考 https://git-core.megvii-inc.com/brain/platform/merge_requests/2008/commits，可以在 commits 中直接链接到 JIRA）

对于需要书写 WIKI 的大型开发任务，我们不建议用一个 MR 来完成，希望能够分拆成多个 JIRA 来实现，每一个 JIRA 对应一个 MR，此时在 WIKI 的设计文档中也应该将拆分的功能列举出来，参考 [INFRA MachineMonitor](https://wiki.megvii-inc.com/display/BRAINPP/INFRA+MachineMonitor) 中的 **实现方案** 一节。

每个 MR 的标题格式如下：

- **如果是新 feature，请用 [Resolves PLATFORM-xxxx] your merge request title**
- **如果是修复 bug，请用** **[Fixes PLATFORM-xxxx] your merge request title**

注：

- 如果该功能较紧急，可以先开一个 JIRA 写完标题，上线之后再做补充。
- 不能在一个 MR 中做极大量文件更改，关于如何定义极大量文件更改，这个由 reviewer 决定，如果 reviewer 发现更改过多，可以将 MR 打回，并建议分拆成多个 MR 合并。

在 **创建 MR** 的时候，请确保 **不要选择 Squash commits when merge request is accepted**  选项。

**对于 reviewer 来说，点击 Merge 请务必确保下面两点：**

- **该 MR 一定是 rebase 到最新的 master 上。**
- **确认已选择 \*<Delete source branch>\* 选项。**
- **根据需求，判断是否需要点击 \**Squash commits when merge request is accepted\** ，如果点击了该选项，请确保 squash commit 符合 commit message 规范。**

## 三、组件规范

### 1. 添加 OWNERS 文件

k8s 在项目中添加了 OWNERS 文件，用于表示该组件的负责人，相关文档见 https://go.k8s.io/owners，我们可以参考他们的方案，在每个微服务组件中添加 OWNERS 标明组件负责人，OWNERS 有两个作用：

- 新人容易找到相应负责人做沟通。
- 可以通过脚本读取 OWNERS 文件做相应的报警等操作。

### 2. 完善组件文档

#### 2.1 新组件

新组件一定需要书写文档，可以在新组件下书写一个 README 文件，简单说明该组件的功能，同时附上 WIKI 文档或者设计文档或者产品文档链接。

#### 2.2 老组件

老组件由组件负责人完善组件文档，对于老组件新添加的功能，需要完善相应的功能文档。

### 3. 测试

所有组件，一旦添加了新功能，代码中如果存在不涉及 grpc 调用，数据库调用的部分，一定要尽可能的书写单元测试。

## 四、code review规范

### 4.1 有效的沟通

- 快速地反馈及响应。developer 和 reviewer 应开启并关注邮件提醒，code review 通知以邮件为主，不再进行钉钉单独通知。
- reviewer 在收到 MR 时，应尽快确认进行 code review 的时间，并在 MR 中进行 comment， code review 响应的时间最晚为下一个工作日。
- discussion 由 reviewer 开启，developer 回复或修改代码后执行 resolve，reviewer 确认若仍有问题，再执行 reopen。
- 若 comment 不是很重要，reviewer 需要在 comment 前加上 “Nit：”，developer 来自行决定是忽略或修复。
- 若 MR 内容过大，reviewer 应立即给出拒绝合并的 comment，待 developer 拆解为小的 MR 后再进行 review。
- reviewer 给出 "LGTM" 视为 approve 该 MR, 若存在多个 reviewer，则全部 reviewer 都给出 "LGTM" 方可视为 approve。

### 4.2 完善的文档

- 是否有 README。

- git comment 是否符合规范。

- - title 是否简明扼要
  - 如有必要，是否关联对应的 JIRA id
  - 若涉及多个部分修改，是否在 body 部分逐条列出。

- MR 是否符合规范。

  - MR 是否过大。
  - MR 的 title 是否绑定 JIRA id（强制）。
  - title 和 changelist 描述是否清晰详细。

- 项目是否包含 OWNERS 文件。

### 4.3 完善的测试及代码覆盖率统计

- MR 内容是否有测试代码覆盖
- 本次 MR 是否会极大降低当前 project 的代码覆盖率

（注：目前项目还没有代码覆盖率的相关统计及对比，后续会进行补充，并作为 MR 时的参考依据。）

进行code review时，reviewer和developer可以参考 [谷歌code review实践（中文版）](https://jimmysong.io/eng-practices/)